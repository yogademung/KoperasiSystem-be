// Koperasi System - Prisma Schema
// Database: kkb_pusat_new (MySQL)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// SYSTEM TABLES (s_*)
// ============================================

model User {
  id         Int       @id @default(autoincrement()) @map("USER_ID")
  username   String    @unique @map("LOGIN") @db.VarChar(50)
  password   String    @map("PWD") @db.VarChar(255)
  fullName   String    @map("NAMA") @db.VarChar(100)
  staffId    String?   @map("STAFF_ID") @db.VarChar(50)
  roleId     Int       @map("ROLE_LPD_ID")
  regionCode String?   @map("WILAYAH_CD") @db.VarChar(20)
  token      String?   @map("TOKEN") @db.Text
  isActive   Boolean   @default(true) @map("ACTIVE_FLAG")
  createdBy  String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt  DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy  String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt  DateTime? @updatedAt @map("CHANGE_DATE")

  role           Role            @relation(fields: [roleId], references: [id])
  postedJournals PostedJournal[]

  @@map("s_user_lpd")
}

model Role {
  id          Int       @id @default(autoincrement()) @map("ROLE_LPD_ID")
  roleName    String    @map("nama_role") @db.VarChar(100)
  description String?   @map("deskripsi") @db.Text
  isActive    Boolean   @default(true) @map("ACTIVE_FLAG")
  createdBy   String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt   DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy   String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt   DateTime? @updatedAt @map("CHANGE_DATE")

  users     User[]
  menuRoles MenuRole[]

  @@map("s_role_lpd")
}

model Menu {
  id        Int       @id @default(autoincrement()) @map("menu_lpd_id")
  menuName  String    @map("nama_menu") @db.VarChar(100)
  module    String?   @map("modul") @db.VarChar(50)
  node      String?   @map("node") @db.VarChar(10)
  parentId  Int?      @map("parent_id")
  icon      String?   @map("icon") @db.VarChar(50)
  path      String?   @map("path") @db.VarChar(255)
  orderNum  Int?      @map("order_num")
  isActive  Boolean   @default(true) @map("ACTIVE_FLAG")
  createdBy String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt DateTime? @updatedAt @map("CHANGE_DATE")

  menuRoles MenuRole[]

  @@map("s_menu_lpd")
}

model MenuRole {
  roleId Int @map("ROLE_LPD_ID")
  menuId Int @map("menu_lpd_id")

  role Role @relation(fields: [roleId], references: [id])
  menu Menu @relation(fields: [menuId], references: [id])

  @@id([roleId, menuId])
  @@map("s_menu_role_lpd")
}

model LovValue {
  code        String    @map("CODE") @db.VarChar(50)
  codeValue   String    @map("CODE_VAL") @db.VarChar(50)
  description String?   @map("DESCRIPTION") @db.VarChar(255)
  orderNum    Int?      @map("ORDER_NUM")
  isActive    Boolean   @default(true) @map("ACTIVE_FLAG")
  createdBy   String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt   DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy   String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt   DateTime? @updatedAt @map("CHANGE_DATE")

  @@id([code, codeValue])
  @@map("s_lov_value")
}

// ============================================
// MASTER DATA TABLES (m_*)
// ============================================

model Nasabah {
  id           Int       @id @default(autoincrement()) @map("NASABAH_ID")
  nama         String    @map("NAMA") @db.VarChar(255)
  noKtp        String?   @unique @map("NO_KTP") @db.VarChar(50)
  alamat       String?   @map("ALAMAT") @db.Text
  email        String?   @map("EMAIL") @db.VarChar(100)
  telepon      String?   @map("TELEPON") @db.VarChar(20)
  tempatLahir  String?   @map("TEMPAT_LAHIR") @db.VarChar(100)
  tanggalLahir DateTime? @map("TANGGAL_LAHIR") @db.Date
  jenisKelamin String?   @map("JENIS_KELAMIN") @db.VarChar(1)
  pekerjaan    String?   @map("PEKERJAAN") @db.VarChar(100)
  fileKtp      String?   @map("FILE_KTP") @db.VarChar(255)
  fileKk       String?   @map("FILE_KK") @db.VarChar(255)
  isActive     Boolean   @default(true) @map("ACTIVE_FLAG")
  createdBy    String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt    DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy    String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt    DateTime? @updatedAt @map("CHANGE_DATE")

  anggota    AnggotaAccount[]
  tabungan   NasabahTab[]
  deposito   NasabahJangka[]
  brahmacari NasabahBrahmacari[]
  balimesari NasabahBalimesari[]
  wanaprasta NasabahWanaprasta[]
  kredit     DebiturKredit[]
  collaterals Collateral[]
  waris      NasabahWaris[]

  @@map("m_nasabah")
}

model AnggotaAccount {
  accountNumber String    @id @map("NO_ANGGOTA") @db.VarChar(20)
  customerId    Int       @map("NASABAH_ID")
  customer      Nasabah   @relation(fields: [customerId], references: [id])
  principal     Decimal   @map("POKOK") @db.Decimal(19, 4)
  mandatoryInit Decimal   @map("WAJIB_AWAL") @db.Decimal(19, 4)
  openDate      DateTime  @map("TGL_DAFTAR") @db.Date
  closeDate     DateTime? @map("TGL_TUTUP") @db.Date
  balance       Decimal   @default(0) @map("SALDO") @db.Decimal(19, 4)
  status        String    @default("D") @map("STATUS") @db.VarChar(2)
  regionCode    String    @map("WILAYAH_CD") @db.VarChar(45)
  groupCode     String    @map("GROUP_CD") @db.VarChar(10)
  remark        String?   @map("REMARK") @db.Text
  deduction     Decimal   @default(0) @map("POTONGAN") @db.Decimal(19, 4)
  isActive      Boolean   @default(true) @map("ACTIVE_FLAG")
  createdBy     String    @map("CREATE_WHO") @db.VarChar(50)
  createdAt     DateTime  @default(now()) @map("CREATE_DATE")

  transactions AnggotaTransaction[]

  @@map("m_nasabah_anggota")
}

model NasabahTab {
  noTab        String    @id @map("NO_TAB") @db.VarChar(50)
  nasabahId    Int       @map("NASABAH_ID")
  tglBuka      DateTime  @map("TGL_BUKA") @db.Date
  saldo        Decimal   @default(0) @map("SALDO") @db.Decimal(19, 4)
  interestRate Decimal   @default(0) @map("BUNGA_PCT") @db.Decimal(5, 2)
  status       String    @default("A") @map("STATUS") @db.VarChar(10)
  createdBy    String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt    DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy    String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt    DateTime? @updatedAt @map("CHANGE_DATE")

  nasabah      Nasabah    @relation(fields: [nasabahId], references: [id])
  transactions TransTab[]

  @@map("m_nasabah_tab")
}

model NasabahJangka {
  noJangka        String    @id @map("NO_JANGKA") @db.VarChar(50)
  nasabahId       Int       @map("NASABAH_ID")
  tglBuka         DateTime  @map("TGL_BUKA") @db.Date
  tglJatuhTempo   DateTime  @map("END_DATE") @db.Date
  nominal         Decimal   @map("NOMINAL") @db.Decimal(19, 4)
  bunga           Decimal   @map("BUNGA") @db.Decimal(5, 2)
  payoutMode      String    @default("MATURITY") @map("PAYOUT_MODE") @db.VarChar(20) // MATURITY, ROLLOVER, TRANSFER
  targetAccountId String?   @map("TARGET_ACCOUNT_ID") @db.VarChar(50) // For TRANSFER mode
  status          String    @default("A") @map("STATUS") @db.VarChar(10)
  createdBy       String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt       DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy       String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt       DateTime? @updatedAt @map("CHANGE_DATE")

  nasabah      Nasabah       @relation(fields: [nasabahId], references: [id])
  transactions TransJangka[]

  @@map("m_nasabah_jangka")
}

model NasabahBrahmacari {
  noBrahmacari String    @id @map("NO_BRAHMACARI") @db.VarChar(50)
  nasabahId    Int       @map("NASABAH_ID")
  tglBuka      DateTime  @map("TGL_BUKA") @db.Date
  saldo        Decimal   @default(0) @map("SALDO") @db.Decimal(19, 4)
  interestRate Decimal   @default(0) @map("BUNGA_PCT") @db.Decimal(5, 2)
  status       String    @default("A") @map("STATUS") @db.VarChar(10)
  createdBy    String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt    DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy    String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt    DateTime? @updatedAt @map("CHANGE_DATE")

  nasabah      Nasabah           @relation(fields: [nasabahId], references: [id])
  transactions TransBrahmacari[]

  @@map("m_nasabah_brahmacari")
}

model NasabahBalimesari {
  noBalimesari String    @id @map("NO_BALIMESARI") @db.VarChar(50)
  nasabahId    Int       @map("NASABAH_ID")
  tglBuka      DateTime  @map("TGL_BUKA") @db.Date
  saldo        Decimal   @default(0) @map("SALDO") @db.Decimal(19, 4)
  interestRate Decimal   @default(0) @map("BUNGA_PCT") @db.Decimal(5, 2)
  status       String    @default("A") @map("STATUS") @db.VarChar(10)
  createdBy    String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt    DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy    String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt    DateTime? @updatedAt @map("CHANGE_DATE")

  nasabah      Nasabah           @relation(fields: [nasabahId], references: [id])
  transactions TransBalimesari[]

  @@map("m_nasabah_balimesari")
}

model NasabahWanaprasta {
  noWanaprasta String    @id @map("NO_WANAPRASTA") @db.VarChar(50)
  nasabahId    Int       @map("NASABAH_ID")
  tglBuka      DateTime  @map("TGL_BUKA") @db.Date
  saldo        Decimal   @default(0) @map("SALDO") @db.Decimal(19, 4)
  interestRate Decimal   @default(0) @map("BUNGA_PCT") @db.Decimal(5, 2)
  status       String    @default("A") @map("STATUS") @db.VarChar(10)
  createdBy    String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt    DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy    String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt    DateTime? @updatedAt @map("CHANGE_DATE")

  nasabah      Nasabah           @relation(fields: [nasabahId], references: [id])
  transactions TransWanaprasta[]

  @@map("m_nasabah_wanaprasta")
}

model NasabahWaris {
  id        Int       @id @default(autoincrement()) @map("WARIS_ID")
  nasabahId Int       @map("NASABAH_ID")
  namaWaris String    @map("NAMA_WARIS") @db.VarChar(255)
  hubungan  String    @map("HUBUNGAN") @db.VarChar(50)
  alamat    String?   @map("ALAMAT") @db.Text
  telepon   String?   @map("TELEPON") @db.VarChar(20)
  createdBy String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt DateTime? @updatedAt @map("CHANGE_DATE")

  nasabah Nasabah @relation(fields: [nasabahId], references: [id])

  @@map("m_nasabah_waris")
}

model DebiturKredit {
  id               Int       @id @default(autoincrement()) @map("DEBITUR_KREDIT_ID")
  nasabahId        Int       @map("NASABAH_ID")
  nomorKredit      String?   @unique @map("NOMOR_KREDIT") @db.VarChar(50)
  noPermohonan     String?   @unique @map("NO_PERMOHONAN") @db.VarChar(50)
  jenisKredit      String    @map("JENIS_KREDIT") @db.VarChar(50)
  tujuanKredit     String?   @map("TUJUAN_KREDIT") @db.Text
  nominalPengajuan Decimal   @map("NOMINAL_PENGAJUAN") @db.Decimal(19, 4)
  status           String    @default("OPEN") @map("STATUS") @db.VarChar(20)
  tglPengajuan     DateTime  @map("TGL_PENGAJUAN") @db.Date
  
  // New fields for Phase 5
  mohonJangkaWaktu Int?      @map("MOHON_JANGKA_WAKTU")
  mohonSukuBunga   Decimal?  @map("MOHON_SUKU_BUNGA") @db.Decimal(5, 2)
  metodeAngsuran   String?   @map("METODE_ANGSURAN") @db.VarChar(20)
  sistemBunga      String?   @map("SISTEM_BUNGA") @db.VarChar(20)
  
  createdBy        String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt        DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy        String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt        DateTime? @updatedAt @map("CHANGE_DATE")

  nasabah      Nasabah            @relation(fields: [nasabahId], references: [id])
  transactions TransKredit[]
  fasilitas    DebiturFasilitas[]
  realisasi    DebiturRealisasi[]
  jadwal       DebiturJadwal[]
  analysis     CreditAnalysis?
  collaterals  KreditCollateral[]

  @@map("m_debitur_kredit")
}

model DebiturFasilitas {
  id              Int       @id @default(autoincrement()) @map("FASILITAS_ID")
  debiturKreditId Int       @map("DEBITUR_KREDIT_ID")
  nominal         Decimal   @map("NOMINAL") @db.Decimal(19, 4)
  bunga           Decimal   @map("BUNGA") @db.Decimal(5, 2)
  jangkaWaktu     Int       @map("JANGKA_WAKTU")
  angsuranPokok   Decimal   @map("ANGSURAN_POKOK") @db.Decimal(19, 4)
  angsuranBunga   Decimal   @map("ANGSURAN_BUNGA") @db.Decimal(19, 4)
  createdBy       String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt       DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy       String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt       DateTime? @updatedAt @map("CHANGE_DATE")

  debiturKredit DebiturKredit @relation(fields: [debiturKreditId], references: [id])

  @@map("m_debitur_fasilitas")
}

model DebiturJadwal {
  id              Int       @id @default(autoincrement()) @map("JADWAL_ID")
  debiturKreditId Int       @map("DEBITUR_KREDIT_ID")
  angsuranKe      Int       @map("ANGSURAN_KE")
  tglJatuhTempo   DateTime  @map("TGL_JATUH_TEMPO") @db.Date
  pokok           Decimal   @map("POKOK") @db.Decimal(19, 4)
  bunga           Decimal   @map("BUNGA") @db.Decimal(19, 4)
  total           Decimal   @map("TOTAL_ANGSURAN") @db.Decimal(19, 4)
  sisaPokok       Decimal   @map("SISA_POKOK") @db.Decimal(19, 4)
  sisaBunga       Decimal   @default(0) @map("SISA_BUNGA") @db.Decimal(19, 4) // New field for partial interest
  status          String    @default("UNPAID") @map("STATUS") @db.VarChar(20) // UNPAID, PARTIAL, PAID, LATE
  tglBayar        DateTime? @map("TGL_BAYAR") @db.Date // Actual payment date

  createdBy       String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt       DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy       String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt       DateTime? @updatedAt @map("CHANGE_DATE")

  debiturKredit DebiturKredit @relation(fields: [debiturKreditId], references: [id])

  @@map("m_debitur_jadwal")
}

model DebiturRealisasi {
  id               Int       @id @default(autoincrement()) @map("REALISASI_ID")
  debiturKreditId  Int       @map("DEBITUR_KREDIT_ID")
  tglRealisasi     DateTime  @map("TGL_REALISASI") @db.Date
  nominalRealisasi Decimal   @map("NOMINAL_REALISASI") @db.Decimal(19, 4)
  rekening         String?   @map("REKENING") @db.VarChar(50)
  createdBy        String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt        DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy        String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt        DateTime? @updatedAt @map("CHANGE_DATE")

  debiturKredit DebiturKredit @relation(fields: [debiturKreditId], references: [id])

  @@map("m_debitur_realisasi")
}


model CreditAnalysis {
  id              Int      @id @default(autoincrement()) @map("ANALISA_ID")
  debiturKreditId Int      @unique @map("DEBITUR_KREDIT_ID")
  characterScore  Int      @map("POINT_CHARACTER")
  characterDesc   String?  @map("URAIAN_CHARACTER") @db.Text
  capitalScore    Int      @map("POINT_CAPITAL")
  capitalDesc     String?  @map("URAIAN_CAPITAL") @db.Text
  capacityScore   Int      @map("POINT_CAPASITY")
  capacityDesc    String?  @map("URAIAN_CAPASITY") @db.Text
  conditionScore  Int      @map("POINT_CONDISION")
  conditionDesc   String?  @map("URAIAN_CONDISION") @db.Text
  collateralScore Int      @map("POINT_COLATERAL")
  collateralDesc  String?  @map("URAIAN_COLATERAL") @db.Text
  totalScore      Int      @map("SCORE")
  recommendation  String?  @map("REKOMENDASI") @db.Text
  
  createdBy       String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt       DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy       String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt       DateTime? @updatedAt @map("CHANGE_DATE")

  debiturKredit   DebiturKredit @relation(fields: [debiturKreditId], references: [id])

  @@map("m_kredit_analisa")
}

model Collateral {
  id              Int      @id @default(autoincrement()) @map("COLATERAL_ID")
  nasabahId       Int      @map("NASABAH_ID")
  type            String   @map("JENIS_JAMINAN") // TANAH, BANGUNAN, KENDARAAN, DEPOSITO, EMAS
  description     String?  @map("KETERANGAN") @db.Text
  marketValue     Decimal  @map("NILAI_PASAR") @db.Decimal(19, 4)
  assessedValue   Decimal  @map("NILAI_TAKASI") @db.Decimal(19, 4)
  details         Json?    @map("DETAIL_DATA") // No Sertifikat/BPKB, Luas, Lokasi, Pemilik
  photos          String?  @map("PHOTOS") @db.Text // JSON array of photo paths
  status          String   @default("ACTIVE") @map("STATUS") // ACTIVE, SEIZED, RELEASED
  
  createdBy       String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt       DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy       String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt       DateTime? @updatedAt @map("CHANGE_DATE")

  nasabah         Nasabah           @relation(fields: [nasabahId], references: [id])
  links           KreditCollateral[]

  @@map("m_debitur_colateral")
}

model KreditCollateral {
  creditId     Int @map("DEBITUR_KREDIT_ID")
  collateralId Int @map("COLATERAL_ID")

  credit     DebiturKredit @relation(fields: [creditId], references: [id])
  collateral Collateral    @relation(fields: [collateralId], references: [id])

  @@id([creditId, collateralId])
  @@map("m_kredit_colateral")
}

model Asset {
  id                         Int      @id @default(autoincrement()) @map("ASSET_ID")
  name                       String   @map("NAMA_AKTIVA")
  code                        String   @unique @map("NO_AKTIVA")
  type                       String   @map("JENIS_AKTIVA") // GEDUNG, KENDARAAN, INVENTARIS, TANAH
  acquisitionDate            DateTime @map("TGL_PEROLEHAN")
  acquisitionCost            Decimal  @map("NILAI_PEROLEHAN") @db.Decimal(19, 4)
  residualValue              Decimal  @map("NILAI_RESIDU") @db.Decimal(19, 4)
  usefulLifeYears            Int      @map("MASA_MANFAAT")
  depreciationRate           Float    @map("PCT_PENYUSUTAN")
  depreciationMethod         String   @map("METODE_PENYUSUTAN") // STRAIGHT_LINE, DECLINING_BALANCE
  assetAccountId             String   @map("ACCOUNT_AKTIVA")
  accumDepreciationAccountId String   @map("ACCOUNT_AKUM_PENY")
  expenseAccountId           String   @map("ACCOUNT_BIAYA_PENY")
  status                     String   @default("ACTIVE") @map("STATUS") // ACTIVE, SOLD, DISPOSED, FULLY_DEPRECIATED
  
  createdBy                  String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt                  DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy                  String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt                  DateTime? @updatedAt @map("CHANGE_DATE")

  depreciationHistory AssetDepreciationHistory[]

  @@map("m_aktiva")
}

model AssetDepreciationHistory {
  id        Int      @id @default(autoincrement()) @map("HISTORY_ID")
  assetId   Int      @map("ASSET_ID")
  period    String   @map("PERIODE") // YYYY-MM
  amount    Decimal  @map("NOMINAL") @db.Decimal(19, 4)
  journalId Int?     @map("JOURNAL_ID")
  createdAt DateTime @default(now()) @map("CREATE_DATE")

  asset Asset @relation(fields: [assetId], references: [id])

  @@map("t_aktiva_penyusutan")
}

// ============================================
// ACCOUNTING TABLES (m_journal_*, t_posted_*)
// ============================================

model JournalAccount {
  accountCode   String    @id @map("ACCOUNT_CD") @db.VarChar(20)
  accountName   String    @map("ACCOUNT_NAME") @db.VarChar(255)
  accountType   String    @map("ACCOUNT_TYPE") @db.VarChar(50) // AST, LIA, EQT, REV, EXP
  parentCode    String?   @map("PARENT_CD") @db.VarChar(20)
  debetPoleFlag Boolean   @default(true) @map("DEBET_POLE_FLAG") // true = Debit Normal, false = Credit Normal
  remark        String?   @map("REMARK") @db.Text
  wilayahCd     String?   @map("WILAYAH_CD") @db.VarChar(10)
  isActive      Boolean   @default(true) @map("ACTIVE_FLAG")
  createdBy     String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt     DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy     String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt     DateTime? @updatedAt @map("CHANGE_DATE")

  journalDetails PostedJournalDetail[]
  debitMappings  ProductCoaMapping[]   @relation("DebitMapping")
  creditMappings ProductCoaMapping[]   @relation("CreditMapping")

  @@map("m_journal_account")
}

model PostedJournal {
  id            Int       @id @default(autoincrement()) @map("JOURNAL_ID")
  journalNumber String    @unique @map("JOURNAL_NO") @db.VarChar(30) // Format: JU/YYYY/MM/XXXX
  journalDate   DateTime  @map("TGL_POSTING") @db.Date
  description   String?   @map("KETERANGAN") @db.Text
  postingType   String    @default("AUTO") @map("POSTING_TYPE") @db.VarChar(10) // MANUAL, AUTO
  transType     String?   @map("TRANS_TYPE") @db.VarChar(30) // SIMPANAN_SETOR, etc.
  sourceCode    String?   @map("SOURCE_CODE") @db.VarChar(20) // ANGGOTA, BRAHMACARI, etc.
  refId         Int?      @map("REF_ID") // Reference to source transaction
  userId        Int       @map("USER_ID")
  tellerId      String?   @map("TELLER_ID") @db.VarChar(20)
  wilayahCd     String?   @map("WILAYAH_CD") @db.VarChar(10)
  status        String    @default("POSTED") @map("STATUS") @db.VarChar(20)
  createdBy     String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt     DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy     String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt     DateTime? @updatedAt @map("CHANGE_DATE")

  details PostedJournalDetail[]
  user    User                  @relation(fields: [userId], references: [id])

  @@map("t_posted_journal")
}

model PostedJournalDetail {
  id          Int     @id @default(autoincrement()) @map("DETAIL_ID")
  journalId   Int     @map("JOURNAL_ID")
  accountCode String  @map("ACCOUNT_CD") @db.VarChar(20)
  debit       Decimal @default(0) @map("DEBIT") @db.Decimal(19, 4)
  credit      Decimal @default(0) @map("CREDIT") @db.Decimal(19, 4)
  description String? @map("KETERANGAN") @db.Text

  journal PostedJournal  @relation(fields: [journalId], references: [id], onDelete: Cascade)
  account JournalAccount @relation(fields: [accountCode], references: [accountCode])

  @@map("t_posted_journal_detail")
}

model PostedJournalTemp {
  id            Int      @id @default(autoincrement()) @map("TEMP_ID")
  originalId    Int      @map("ORIGINAL_JOURNAL_ID")
  journalNumber String   @map("JOURNAL_NO") @db.VarChar(30)
  journalDate   DateTime @map("TGL_POSTING") @db.Date
  description   String?  @map("KETERANGAN") @db.Text
  postingType   String   @map("POSTING_TYPE") @db.VarChar(10)
  transType     String?  @map("TRANS_TYPE") @db.VarChar(30)
  sourceCode    String?  @map("SOURCE_CODE") @db.VarChar(20)
  refId         Int?     @map("REF_ID")
  userId        Int      @map("USER_ID")
  wilayahCd     String?  @map("WILAYAH_CD") @db.VarChar(10)
  status        String   @map("STATUS") @db.VarChar(20)
  deletedBy     String?  @map("DELETE_WHO") @db.VarChar(50)
  deletedAt     DateTime @default(now()) @map("DELETE_DATE")
  deleteReason  String?  @map("DELETE_REASON") @db.Text

  details PostedJournalDetailTemp[]

  @@map("t_posted_journal_temp")
}

model PostedJournalDetailTemp {
  id            Int     @id @default(autoincrement()) @map("TEMP_DETAIL_ID")
  tempJournalId Int     @map("TEMP_JOURNAL_ID")
  accountCode   String  @map("ACCOUNT_CD") @db.VarChar(20)
  debit         Decimal @default(0) @map("DEBIT") @db.Decimal(19, 4)
  credit        Decimal @default(0) @map("CREDIT") @db.Decimal(19, 4)
  description   String? @map("KETERANGAN") @db.Text

  journal PostedJournalTemp @relation(fields: [tempJournalId], references: [id], onDelete: Cascade)

  @@map("t_posted_journal_detail_temp")
}

model ProductCoaMapping {
  id          Int    @id @default(autoincrement()) @map("MAPPING_ID")
  module      String @map("MODULE") @db.VarChar(20) // SIMPANAN, KREDIT
  transType   String @unique @map("TRANS_TYPE") @db.VarChar(30) // BRAHMACARI_SETOR, etc.
  description String @map("DESCRIPTION") @db.VarChar(100)

  debitAccount  String @map("DEBIT_ACCOUNT_CD") @db.VarChar(20)
  creditAccount String @map("CREDIT_ACCOUNT_CD") @db.VarChar(20)

  debitRef  JournalAccount @relation("DebitMapping", fields: [debitAccount], references: [accountCode])
  creditRef JournalAccount @relation("CreditMapping", fields: [creditAccount], references: [accountCode])

  updatedAt DateTime @updatedAt @map("CHANGE_DATE")

  @@map("m_product_coa_mapping")
}

// ============================================
// TRANSACTION TABLES (t_*)
// ============================================

model AnggotaTransaction {
  id            Int            @id @default(autoincrement()) @map("TRANS_ID")
  accountNumber String         @map("NO_ANGGOTA") @db.VarChar(20)
  account       AnggotaAccount @relation(fields: [accountNumber], references: [accountNumber])
  transDate     DateTime       @map("TGL_TRANS")
  transType     String         @map("TIPE_TRANS") @db.VarChar(20)
  amount        Decimal        @map("NOMINAL") @db.Decimal(19, 4)
  balanceAfter  Decimal        @map("SALDO_AKHIR") @db.Decimal(19, 4)
  description   String?        @map("KETERANGAN") @db.Text
  userId        Int            @map("USER_ID")
  createdAt     DateTime       @default(now()) @map("CREATE_DATE")

  @@map("t_trans_anggota")
}

model TransTab {
  id         Int      @id @default(autoincrement()) @map("TRANS_ID")
  noTab      String   @map("NO_TAB") @db.VarChar(50)
  tipeTrans  String   @map("TIPE_TRANS") @db.VarChar(10)
  nominal    Decimal  @map("NOMINAL") @db.Decimal(19, 4)
  saldoAkhir Decimal  @map("SALDO_AKHIR") @db.Decimal(19, 4)
  keterangan String?  @map("KETERANGAN") @db.Text
  createdBy  String?  @map("CREATE_WHO") @db.VarChar(50)
  createdAt  DateTime @default(now()) @map("CREATE_DATE")

  tabungan NasabahTab @relation(fields: [noTab], references: [noTab])

  @@map("t_trans_tab")
}

model TransJangka {
  id         Int      @id @default(autoincrement()) @map("TRANS_ID")
  noJangka   String   @map("NO_JANGKA") @db.VarChar(50)
  tipeTrans  String   @map("TIPE_TRANS") @db.VarChar(10)
  nominal    Decimal  @map("NOMINAL") @db.Decimal(19, 4)
  keterangan String?  @map("KETERANGAN") @db.Text
  createdBy  String?  @map("CREATE_WHO") @db.VarChar(50)
  createdAt  DateTime @default(now()) @map("CREATE_DATE")

  deposito NasabahJangka @relation(fields: [noJangka], references: [noJangka])

  @@map("t_trans_jangka")
}

model TransBrahmacari {
  id           Int      @id @default(autoincrement()) @map("TRANS_ID")
  noBrahmacari String   @map("NO_BRAHMACARI") @db.VarChar(50)
  tipeTrans    String   @map("TIPE_TRANS") @db.VarChar(10)
  nominal      Decimal  @map("NOMINAL") @db.Decimal(19, 4)
  saldoAkhir   Decimal  @map("SALDO_AKHIR") @db.Decimal(19, 4)
  keterangan   String?  @map("KETERANGAN") @db.Text
  createdBy    String?  @map("CREATE_WHO") @db.VarChar(50)
  createdAt    DateTime @default(now()) @map("CREATE_DATE")

  brahmacari NasabahBrahmacari @relation(fields: [noBrahmacari], references: [noBrahmacari])

  @@map("t_trans_brahmacari")
}

model TransBalimesari {
  id           Int      @id @default(autoincrement()) @map("TRANS_ID")
  noBalimesari String   @map("NO_BALIMESARI") @db.VarChar(50)
  tipeTrans    String   @map("TIPE_TRANS") @db.VarChar(10)
  nominal      Decimal  @map("NOMINAL") @db.Decimal(19, 4)
  saldoAkhir   Decimal  @map("SALDO_AKHIR") @db.Decimal(19, 4)
  keterangan   String?  @map("KETERANGAN") @db.Text
  createdBy    String?  @map("CREATE_WHO") @db.VarChar(50)
  createdAt    DateTime @default(now()) @map("CREATE_DATE")

  balimesari NasabahBalimesari @relation(fields: [noBalimesari], references: [noBalimesari])

  @@map("t_trans_balimesari")
}

model TransWanaprasta {
  id           Int      @id @default(autoincrement()) @map("TRANS_ID")
  noWanaprasta String   @map("NO_WANAPRASTA") @db.VarChar(50)
  tipeTrans    String   @map("TIPE_TRANS") @db.VarChar(10)
  nominal      Decimal  @map("NOMINAL") @db.Decimal(19, 4)
  saldoAkhir   Decimal  @map("SALDO_AKHIR") @db.Decimal(19, 4)
  keterangan   String?  @map("KETERANGAN") @db.Text
  createdBy    String?  @map("CREATE_WHO") @db.VarChar(50)
  createdAt    DateTime @default(now()) @map("CREATE_DATE")

  wanaprasta NasabahWanaprasta @relation(fields: [noWanaprasta], references: [noWanaprasta])

  @@map("t_trans_wanaprasta")
}

model TransKredit {
  id              Int      @id @default(autoincrement()) @map("TRANS_ID")
  debiturKreditId Int      @map("DEBITUR_KREDIT_ID")
  tipeTrans       String   @map("TIPE_TRANS") @db.VarChar(10)
  nominal         Decimal  @map("NOMINAL") @db.Decimal(19, 4)
  keterangan      String?  @map("KETERANGAN") @db.Text
  createdBy       String?  @map("CREATE_WHO") @db.VarChar(50)
  createdAt       DateTime @default(now()) @map("CREATE_DATE")

  kredit DebiturKredit @relation(fields: [debiturKreditId], references: [id])

  @@map("t_trans_kredit")
}

// ============================================
// REPORTING SYSTEM TABLES (Phase 4)
// ============================================

model ReportTemplate {
  id            Int     @id @default(autoincrement()) @map("TEMPLATE_ID")
  code          String  @unique @map("TEMPLATE_CODE") @db.VarChar(20) // S01, K01, AK22, etc.
  name          String  @map("TEMPLATE_NAME") @db.VarChar(255)
  description   String? @map("DESCRIPTION") @db.Text
  productModule String  @map("PRODUCT_MODULE") @db.VarChar(50) // SIMPANAN, KREDIT, ACCOUNTING, ASSET
  category      String  @map("CATEGORY") @db.VarChar(50) // STATEMENT, CERTIFICATE, FORM, REPORT

  // Template Definition (JSON Schema)
  jsonSchema Json @map("JSON_SCHEMA") // Complete template structure

  // Paper Settings
  paperSize    String   @default("A4") @map("PAPER_SIZE") @db.VarChar(20) // A4, LETTER, LEGAL, CUSTOM
  orientation  String   @default("portrait") @map("ORIENTATION") @db.VarChar(20) // portrait, landscape
  customWidth  Decimal? @map("CUSTOM_WIDTH") @db.Decimal(10, 2) // in mm
  customHeight Decimal? @map("CUSTOM_HEIGHT") @db.Decimal(10, 2) // in mm
  marginTop    Decimal  @default(20) @map("MARGIN_TOP") @db.Decimal(10, 2) // in mm
  marginBottom Decimal  @default(20) @map("MARGIN_BOTTOM") @db.Decimal(10, 2)
  marginLeft   Decimal  @default(20) @map("MARGIN_LEFT") @db.Decimal(10, 2)
  marginRight  Decimal  @default(20) @map("MARGIN_RIGHT") @db.Decimal(10, 2)

  // Versioning
  version   Int     @default(1) @map("VERSION")
  isDefault Boolean @default(false) @map("IS_DEFAULT") // System default template
  isActive  Boolean @default(true) @map("ACTIVE_FLAG")
  parentId  Int?    @map("PARENT_ID") // For custom versions of default templates

  // Metadata
  createdBy String?   @map("CREATE_WHO") @db.VarChar(50)
  createdAt DateTime  @default(now()) @map("CREATE_DATE")
  updatedBy String?   @map("CHANGE_WHO") @db.VarChar(50)
  updatedAt DateTime? @updatedAt @map("CHANGE_DATE")

  parent         ReportTemplate?       @relation("TemplateVersions", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  versions       ReportTemplate[]      @relation("TemplateVersions")
  generationLogs ReportGenerationLog[]

  @@map("report_template")
}

model ReportVariable {
  id            Int     @id @default(autoincrement()) @map("VARIABLE_ID")
  productModule String  @map("PRODUCT_MODULE") @db.VarChar(50) // SIMPANAN, KREDIT, etc.
  variableKey   String  @map("VARIABLE_KEY") @db.VarChar(100) // nasabah_nama, no_rek, etc.
  variableName  String  @map("VARIABLE_NAME") @db.VarChar(255) // Display name
  dataType      String  @map("DATA_TYPE") @db.VarChar(20) // STRING, NUMBER, DATE, CURRENCY, BOOLEAN
  category      String  @map("CATEGORY") @db.VarChar(50) // HEADER, CUSTOMER, ACCOUNT, TRANSACTION
  description   String? @map("DESCRIPTION") @db.Text
  sampleValue   String? @map("SAMPLE_VALUE") @db.VarChar(255) // For preview
  isArray       Boolean @default(false) @map("IS_ARRAY") // For loop variables

  // Formatting Options (JSON)
  formatOptions Json? @map("FORMAT_OPTIONS") // { dateFormat: "DD-MM-YYYY", currencySymbol: "Rp" }

  createdAt DateTime  @default(now()) @map("CREATE_DATE")
  updatedAt DateTime? @updatedAt @map("CHANGE_DATE")

  @@unique([productModule, variableKey])
  @@map("report_variable")
}

model ReportGenerationLog {
  id         Int            @id @default(autoincrement()) @map("LOG_ID")
  templateId Int            @map("TEMPLATE_ID")
  template   ReportTemplate @relation(fields: [templateId], references: [id])

  recordId   String? @map("RECORD_ID") @db.VarChar(100) // Reference to source record (account no, etc.)
  format     String  @map("FORMAT") @db.VarChar(10) // PDF, EXCEL
  parameters Json?   @map("PARAMETERS") // Input parameters used

  status       String  @map("STATUS") @db.VarChar(20) // SUCCESS, FAILED
  errorMessage String? @map("ERROR_MESSAGE") @db.Text
  filePath     String? @map("FILE_PATH") @db.VarChar(500) // Generated file path
  fileSize     Int?    @map("FILE_SIZE") // in bytes

  generatedBy String?  @map("GENERATED_BY") @db.VarChar(50)
  generatedAt DateTime @default(now()) @map("GENERATED_DATE")

  @@map("report_generation_log")
}

// Passbook Printing State (for continuous printing)
model PassbookPrintState {
  id            Int    @id @default(autoincrement()) @map("STATE_ID")
  accountNumber String @unique @map("ACCOUNT_NUMBER") @db.VarChar(50)
  productType   String @map("PRODUCT_TYPE") @db.VarChar(50) // ANGGOTA, TABRELA, etc.

  lastPrintedTransId Int? @map("LAST_PRINTED_TRANS_ID") // Last transaction ID printed
  lastPrintedLine    Int  @default(1) @map("LAST_PRINTED_LINE") // Last line number used (1-based)
  totalLinesPrinted  Int  @default(0) @map("TOTAL_LINES_PRINTED")

  updatedAt DateTime @updatedAt @map("LAST_PRINT_DATE")

  @@map("passbook_print_state")
}
